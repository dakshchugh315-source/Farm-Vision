<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FarmVision â€” Live Camera</title>

  <!-- Tailwind + DaisyUI + Flowbite -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.js"></script>

  <style>
    body {
      font-family: Inter, system-ui, sans-serif;
      color: #f0fdf4;
      position: relative;
      min-height: 100vh;
    }
    /* Fixed background */
    .green-pasture-bg {
      background-image: url('https://wallpapershome.com/images/pages/pic_h/19901.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    /* Overlay tint */
    .green-pasture-bg::before {
      content: "";
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(17, 24, 39, 0.65);
      z-index: -1;
    }
    .profile-card {
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.1);
      backdrop-filter: blur(8px);
    }
    .confidence-rainbow {
      background: linear-gradient(90deg,#ff0000,#ff7f00,#ffff00,#00ff00,#0000ff,#4b0082,#8b00ff);
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center p-6 green-pasture-bg">

  <!-- Navbar -->
  <nav class="navbar w-full max-w-6xl mb-6 bg-base-100/80 backdrop-blur rounded-xl">
    <div class="flex-1">
      <a class="btn btn-ghost normal-case text-lg">FarmVision</a>
    </div>
    <div class="flex-none">
      <ul class="menu menu-horizontal px-1">
        <li><a href="classifier.html">Classifier</a></li>
        <li><a href="live-camera.html">Live Camera</a></li>
        <li><a href="health.html">Health Scan</a></li>
        <li><a href="history.html">History</a></li>
      </ul>
    </div>
  </nav>

  <!-- Profile Section -->
  <div class="w-full max-w-6xl mb-6 profile-card rounded-xl p-4 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <div id="profileAvatar" class="w-14 h-14 rounded-full bg-gradient-to-br from-teal-400 to-green-600 flex items-center justify-center text-2xl font-bold text-white shadow-lg">U</div>
      <div>
        <p id="profileName" class="text-xl font-extrabold text-white drop-shadow-md">Welcome</p>
        <p class="text-sm text-gray-200">Live Camera Mode</p>
      </div>
    </div>
    <div>
      <button id="logoutBtn" class="btn btn-error btn-sm">Logout</button>
    </div>
  </div>

  <!-- Live Camera Section -->
  <div class="w-full max-w-4xl bg-base-100/80 backdrop-blur rounded-xl p-6 shadow-xl">
    <h2 class="text-2xl font-bold mb-4">Live Camera</h2>

    <!-- Video Preview -->
    <div class="relative rounded-lg overflow-hidden bg-black mb-4">
      <video id="video" autoplay playsinline class="w-full max-h-[400px] object-contain"></video>
      <!-- Switch Camera Button -->
      <button id="switchCameraBtn" 
        class="absolute bottom-3 right-3 bg-white text-black rounded-full p-3 shadow-lg hover:bg-gray-200 transition">
        ðŸ“·
      </button>
    </div>

    <!-- Buttons -->
    <div class="flex gap-3 mb-6">
      <button id="startBtn" class="btn btn-primary">Start Camera</button>
      <button id="stopBtn" class="btn btn-warning" disabled>Stop Camera</button>
      <button id="captureBtn" class="btn btn-accent" disabled>Capture Photo</button>
    </div>

    <!-- Captured Preview + Classification -->
    <div id="captureCard" class="hidden mt-6">
      <h3 class="text-lg font-semibold mb-3">Captured Frame</h3>
      <div class="card bg-base-200 shadow-lg">
        <div class="card-body flex flex-col gap-4">
          <img id="capturedImage" class="rounded-lg w-full object-contain max-h-[250px]" />
          <p class="text-sm text-gray-300">Timestamp: <span id="captureTime"></span></p>

          <!-- Result Section -->
          <div id="resultBox" class="hidden">
            <div class="flex justify-between items-center mb-2">
              <h4 class="font-bold">Verdict: <span id="verdictText"></span></h4>
              <span id="confidenceBadge" class="badge"></span>
            </div>
            <p class="text-sm">Breed: <span id="breedText"></span></p>
            <div class="w-full h-2 bg-gray-700 rounded-full overflow-hidden my-2">
              <div id="confidenceBar" class="h-full confidence-rainbow" style="width:0%;"></div>
            </div>
            <p class="text-xs text-gray-300">Explanation:</p>
            <p id="explanationText" class="text-xs text-gray-200"></p>
          </div>

          <div class="flex gap-2">
            <button id="retakeBtn" class="btn btn-outline btn-sm">Retake</button>
            <button id="saveHistoryBtn" class="btn btn-success btn-sm hidden">Save to History</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Footer -->
  <footer class="mt-10 text-center text-xs text-white/60">
    Â© FarmVision â€” For BPA pilots
  </footer>

  <script>
    // Profile setup
    (function(){
      const storedName = localStorage.getItem('userName') || 'User';
      document.getElementById('profileName').textContent = storedName;
      document.getElementById('profileAvatar').textContent = storedName.charAt(0).toUpperCase();
      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('userName');
        window.location.href = "index.html";
      });
    })();

    const video = document.getElementById("video");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const captureBtn = document.getElementById("captureBtn");
    const captureCard = document.getElementById("captureCard");
    const capturedImage = document.getElementById("capturedImage");
    const captureTime = document.getElementById("captureTime");
    const resultBox = document.getElementById("resultBox");
    const verdictText = document.getElementById("verdictText");
    const breedText = document.getElementById("breedText");
    const confidenceBar = document.getElementById("confidenceBar");
    const confidenceBadge = document.getElementById("confidenceBadge");
    const explanationText = document.getElementById("explanationText");
    const saveHistoryBtn = document.getElementById("saveHistoryBtn");
    const retakeBtn = document.getElementById("retakeBtn");
    const switchCameraBtn = document.getElementById("switchCameraBtn");

    let stream = null;
    let capturedDataUrl = "";
    let currentFacingMode = "user"; // default to front camera

    // Multiple Gemini API keys
    const apiKeys = [
          "AIzaSyASt6sFVBV3WaLd4nx-Px1j3g8p6SNx9po",
          "AIzaSyDyGUvcbFrTAlYTlB8_WfP-pM6WzYrk9_4",
          "AIzaSyCQyn4iw3VSBPGvRjQTNtwwbBrqzcvT1js",
        ];
    let currentKeyIndex = 0;

    function getCurrentApiKey() {
      return apiKeys[currentKeyIndex];
    }

    function switchToNextKey() {
      currentKeyIndex++;
      if (currentKeyIndex >= apiKeys.length) {
        return false; // no more keys
      }
      return true;
    }

    function extractTextFromResponse(obj) {
      if (!obj) return null;
      if (typeof obj === "string") return obj;
      if (Array.isArray(obj)) return obj.map(extractTextFromResponse).join(" ");
      if (typeof obj === "object") {
        if (obj.candidates && Array.isArray(obj.candidates)) {
          return extractTextFromResponse(obj.candidates[0]);
        }
        if (obj.content && obj.content.parts) {
          return obj.content.parts.map(p => p.text || "").join(" ");
        }
        return Object.values(obj).map(extractTextFromResponse).join(" ");
      }
      return null;
    }

    async function classifyImage(dataUrl) {
      const base64 = dataUrl.split(",")[1];
      const payload = {
        contents: [{
          parts: [
            { text: "Classify this animal image. Identify if it is a 'Cattle' or 'Buffalo'. Provide a specific breed name. If the breed is not native to India (foreign), the response MUST be:\nVerdict: Not Indian\nBreed: International\nConfidence: [0-100%]\nExplanation: [Your explanation]. If it is not a cattle or buffalo, then Verdict should be 'Other' and Breed 'N/A'." },
            { inlineData: { mimeType: "image/png", data: base64 } }
          ]
        }]
      };

      while (currentKeyIndex < apiKeys.length) {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${encodeURIComponent(getCurrentApiKey())}`;
        try {
          const response = await fetch(apiUrl, { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(payload) });
          if (!response.ok) {
            if (response.status === 403 || response.status === 429) {
              // switch to next key
              if (!switchToNextKey()) throw new Error("All API keys exhausted.");
              continue;
            } else {
              throw new Error("API error " + response.status);
            }
          }
          const json = await response.json();
          return extractTextFromResponse(json) || "";
        } catch (err) {
          if (!switchToNextKey()) throw err;
        }
      }
      throw new Error("No API keys available.");
    }

    async function startCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: currentFacingMode }
        });
        video.srcObject = stream;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        captureBtn.disabled = false;
      } catch (err) {
        alert("Camera access denied or unavailable.");
      }
    }

    // Start camera button
    startBtn.addEventListener("click", startCamera);

    // Stop camera
    stopBtn.addEventListener("click", () => {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      video.srcObject = null;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      captureBtn.disabled = true;
    });

    // Switch camera
    switchCameraBtn.addEventListener("click", async () => {
      currentFacingMode = currentFacingMode === "user" ? "environment" : "user";
      await startCamera();
    });

    // Capture and classify
    captureBtn.addEventListener("click", async () => {
      if (!stream) return;
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0);
      capturedDataUrl = canvas.toDataURL("image/png");

      capturedImage.src = capturedDataUrl;
      captureTime.textContent = new Date().toLocaleString();
      captureCard.classList.remove("hidden");

      resultBox.classList.add("hidden");
      verdictText.textContent = "Processing...";
      breedText.textContent = "-";
      confidenceBadge.textContent = "";
      explanationText.textContent = "";

      try {
        const fullText = await classifyImage(capturedDataUrl);

        const get = (rx) => (fullText.match(rx)?.[1] || "").trim();
        let verdict = get(/Verdict\s*[:\-]*\s*([A-Za-z ]+)/i) || "Other";
        let breed = get(/Breed\s*[:\-]*\s*([A-Za-z \-]+)/i);
        const confidence = get(/Confidence\s*[:\-]*\s*([0-9]{1,3}%?)/i) || "0%";
        const explanation = get(/Explanation\s*[:\-]*([\s\S]+)/i) || "";

        // Special cases
        if (verdict.toLowerCase() === "other" || verdict.toLowerCase() === "others") {
            breed = "None";
        } else if (verdict.toLowerCase().includes("not indian")) {
            verdict = "Not Indian";
            breed = "International";
        }

        verdictText.textContent = verdict;
        breedText.textContent = breed;
        confidenceBadge.textContent = confidence;
        const confVal = parseInt(confidence) || 0;
        confidenceBar.style.width = confVal + "%";
        explanationText.textContent = explanation || "No explanation provided.";

        resultBox.classList.remove("hidden");
        saveHistoryBtn.classList.remove("hidden");

        // âœ… Save only metadata (no heavy Base64 image)
        const history = JSON.parse(localStorage.getItem("farmVisionHistory") || "[]");
        history.unshift({
            timestamp: new Date().toLocaleString(),
            verdict: verdict,
            breed: breed,
            confidence: confidence,
            explanation: explanation,
            imageName: "Live Capture"
        });
        localStorage.setItem("farmVisionHistory", JSON.stringify(history.slice(0, 200)));

      } catch (err) {
        verdictText.textContent = "Error";
        breedText.textContent = "N/A";
        explanationText.textContent = "Classification failed: " + err.message;
      }
    });

    // Retake
    retakeBtn.addEventListener("click", () => {
      capturedDataUrl = "";
      captureCard.classList.add("hidden");
    });
  </script>
</body>
</html>
